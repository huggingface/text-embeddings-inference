from typing import Any, Dict, Generator
from _pytest.fixtures import SubRequest

import pytest
import pytest_asyncio
import numpy as np


# The "args" values in TEST_CONFIGS are not optimized for speed but only check that the inference is working for the different models architectures.
TEST_CONFIGS = {
    "BAAI/bge-large-en-v1.5": {
        "model_id": "BAAI/bge-large-en-v1.5",
        "input": "What is Deep Learning?",
        "expected_output": "[[0.01712719, 0.003211348, -0.050762516, -0.03549249, 0.013412859, -0.023420917, -0.015270025, -0.021254225, -0.004565531, 0.06479443, 0.013309684, 0.02930194, 0.023936795, -0.03507979, -0.019706586, -0.003894888, -0.017230365, -0.0062421383, -0.04539737, -0.0035853605, -0.027651126, 0.051794272, -0.027651126, -0.004668707, -0.03817506, 0.012019985, 0.07098498, 0.027238423, 0.04807994, 0.034667082, -0.018778004, -0.026413016, 0.008563595, -0.03177816, -0.019912938, -0.012019985, 0.0106787, -0.024762202, -0.062730916, -0.052826032, -0.015166849, 0.03177816, 0.023524093, -0.09409637, -0.05220698, 0.010988227, 0.038587764, 0.0025793961, -0.015579552, -0.003946476, -0.0078413645, 0.030127347, -0.00918265, -0.014341442, 0.016508136, -0.02207963, 0.014857322, 0.02930194, 0.018571652, -0.0042302096, 0.046635482, -0.021047872, 0.018674828, -0.042302094, 0.029920995, 0.0025407053, 0.010575524, -0.04168304, -0.020531993, -0.02806383, -0.050968867, -0.005055616, 0.00918265, -0.038381413, -0.01588908, 0.024452675, -0.0061647566, 0.043127503, -0.044571966, 0.0063195205, 0.01588908, 0.049524404, -0.025587609, 0.028270181, -0.015682729, -0.03177816, 0.043540206, 0.03446073, -0.006087375, -0.028682884, 0.020222465, 0.023008212, 0.0030565844, 0.019809762, -0.019706586, 0.02579396, -0.015063673, 0.024452675, 0.002772851, 0.023420917, 0.017952597, 0.060667396, -0.01712719, 0.08171527, -0.04807994, 0.009801705, 0.015785905, -0.0060099927, -0.027238423, -0.047460888, -0.0144446185, -0.0009350311, -0.011349343, -0.01588908, -0.035698842, 0.025587609, -0.0076866006, 0.01712719, -0.006654842, 0.00794454, 0.024143148, 0.0144446185, 0.02259551, 0.018674828, 0.016404958, -0.048492648, -0.019706586, 0.0035853605, -0.009543765, 0.0013799769, -0.00061905506, -0.03446073, -0.01191681, 0.03507979, 0.0043075914, -0.0427148, 0.0075318366, 0.03920682, -0.021770103, 0.0022698685, 0.020531993, -0.013051745, -0.01217475, 0.05860388, -0.04807994, 0.004591325, -0.0094921775, 0.010575524, -0.009904881, 0.021254225, -0.027238423, 0.009750118, 0.024246324, 0.0062937266, -0.071397685, -0.0427148, -0.026825719, 0.035698842, -0.0035595666, 0.0078413645, 0.012019985, 0.0062937266, -0.033222623, 0.042302094, -0.0015218437, 0.050349813, -0.04044493, -0.043746557, 0.014857322, -0.016508136, 0.028889237, -0.008873123, -0.02610349, -0.012277925, -0.012226338, 0.057365768, 0.050556164, -0.021151047, 0.025174906, -0.013103332, -0.0103175845, -0.032809917, -0.014238266, 0.0042302096, 0.002643881, -0.014857322, -0.022492334, 0.016714487, -0.06520713, 0.026413016, 0.015476377, 0.016404958, -0.04188939, 0.011555694, -0.016301783, 0.020531993, -0.03404803, 0.0037659183, 0.008305656, -0.04250845, 0.012019985, 0.046841834, -0.0036885364, -0.003327421, -0.013722387, 0.07057228, 0.016920839, 0.055714957, -0.06396902, 0.01939706, 0.019706586, 0.008976298, -0.02403997, 0.008512007, 0.044365615, -0.043746557, -0.06685795, -0.0014315648, 0.006422696, -0.022801861, 0.01939706, 0.0213574, 0.03900047, 0.008047716, -0.015992256, -0.026825719, -0.009389002, 0.023936795, -0.028682884, 0.01712719, 0.013206508, 0.07800094, -0.0106787, 0.020428818, 0.017436717, 0.023524093, 0.010936639, 0.041270338, 0.01939706, 0.036111545, -0.013928739, -0.019912938, 0.025897136, 0.028889237, -0.0003933579, -0.025381258, 0.014341442, 0.003327421, 0.004359179, 0.0136192115, -0.029920995, 0.012432689, 0.026619367, -0.0013864255, -0.03198451, 0.046222776, 0.04498467, 0.02930194, -0.03404803, -0.04147669, -0.01960341, 0.06314362, -0.012639041, -0.016920839, 0.01908753, -0.0075318366, 0.016508136, 0.003275833, -0.02930194, -0.02806383, -0.03776236, -0.078826346, -0.062730916, -0.018262124, -0.02630984, -0.008357244, 0.0062679327, -0.025897136, 0.0111429915, -0.0073770727, 0.007789776, -0.0063711083, -0.012432689, -0.00090278866, 0.04044493, 0.01908753, -0.040032227, 0.02403997, -0.036111545, -0.004875059, -0.011246167, -0.008873123, -0.020428818, -0.0037401244, 0.013206508, -0.028270181, 0.029095588, -0.024865378, -0.028682884, -0.019912938, 0.013825563, -0.040238578, -0.032397214, 0.045603722, -0.02610349, 0.024865378, 0.032190863, -0.0013735284, 0.028270181, 0.011762046, -0.052826032, 0.028889237, 0.017746245, 0.013051745, -0.030952753, 0.03198451, 0.023627268, -0.027857479, 0.004127034, -0.057778474, -0.040651284, -0.00054167316, 0.0073770727, -0.0734612, 0.010162821, 0.045603722, 0.0050040283, -0.0850169, 0.0213574, -0.03425438, -0.014547794, -0.010833464, 0.04044493, 0.02950829, 0.035905194, 0.019912938, -0.03404803, 0.0034048029, -0.02403997, 0.027444774, 0.034873433, -0.04044493, 0.024762202, 0.035698842, 0.005261968, 0.017230365, -0.020944696, -0.01960341, 0.034873433, 0.028682884, 0.033635326, 0.02950829, 0.0103175845, -0.010111232, 0.020119289, -0.027651126, -0.039619524, 0.05261968, 0.021873279, -0.0031984511, 0.03776236, 0.040651284, 0.00054167316, 0.013309684, -0.011968398, 0.0024375294, -0.021151047, 0.014960498, 0.047460888, -0.04147669, 0.027651126, 0.008976298, -0.039825875, 0.03507979, -0.052826032, -0.028476533, 0.014238266, -0.0367306, 0.021460576, -0.07015958, -0.005777847, 0.026206665, -0.01191681, 0.025690785, 0.023730444, 0.04807994, -0.022905037, 0.0076350123, -0.021770103, 0.011658871, 0.022698686, -0.013722387, -0.05901658, 0.016817663, -0.027238423, -0.016611312, 0.05901658, 0.0019603411, 0.031365458, -0.018262124, 0.080477156, -0.010730288, 0.020531993, 0.008150891, -0.0018184743, 0.004152828, -0.033428974, -0.0062937266, 0.03446073, -0.0029405116, -0.009079474, 0.008047716, 0.03198451, -0.042302094, -0.026619367, -0.003946476, 0.0047460888, -0.051794272, -0.021873279, 0.06231821, -0.025587609, 0.011452518, -0.089556634, 0.016611312, 0.023317741, -0.061905507, 0.033635326, -0.028682884, 0.05530225, 0.025381258, -0.027651126, -0.03796871, 0.0019216501, -0.015063673, -0.038381413, 0.0054683196, 0.053238735, -0.03446073, 0.040032227, -0.038587764, -0.0213574, -0.001999032, 0.066032544, -0.0028760266, -0.020016113, -0.021666927, -0.013722387, 0.038587764, 0.011400931, -0.009389002, -0.008873123, -0.039413173, 0.0491117, -0.026825719, -0.030746402, 0.023627268, -0.011039815, -0.029095588, 0.011452518, 0.0144446185, 0.03054005, -0.0035337727, 0.05530225, -0.045810074, -0.04395291, 0.044778317, -0.02259551, -0.0049782344, 0.042921152, 0.011349343, -0.025484433, -0.0063453144, 0.057365768, -0.051175218, 0.052000627, -0.015373201, 0.023420917, -0.011504106, -0.03054005, -0.021460576, -0.04642913, 0.043540206, -0.00036595183, -0.0024633233, -0.020531993, -0.053238735, -0.022801861, 0.011246167, -0.034667082, -0.0025664992, -0.032397214, 0.013516036, 0.026619367, 0.010369172, 0.011246167, 0.055714957, -0.0049008527, 0.027032072, 0.03507979, 0.012381101, 0.029920995, -0.033841677, -0.05901658, -0.0035337727, -0.033222623, 0.0065258723, -0.033635326, 0.021976454, -0.008202479, 0.0243495, -0.021254225, 0.0018958561, 0.005958405, 0.01888118, 0.02259551, -0.010833464, -0.023008212, 0.004127034, -0.0029405116, 0.07098498, 0.032603566, -0.046016425, -0.07263579, 0.04415926, -0.047254536, 0.0103175845, 0.0060099927, -0.050349813, 0.015063673, -0.04188939, 0.054064143, -0.05014346, -0.016198607, -0.032809917, -0.0018958561, -0.0075834244, 0.015270025, -0.017333541, -0.005984199, 0.026000313, -0.044365615, 0.012123162, -0.00017975166, 0.0094921775, -0.064381726, 0.0047460888, -0.02930194, 0.049730755, 0.0068096058, -0.03900047, 0.0062163444, -0.020635169, 0.033841677, 0.020119289, -0.069334164, -0.023627268, 0.015579552, -0.025381258, 0.05488955, 0.034873433, -0.01960341, 0.028270181, -0.013206508, 0.0038175061, -0.034873433, 0.01588908, -0.0025149111, -0.04168304, 0.041270338, -0.060254693, 0.010369172, 0.0056230836, 0.015166849, 0.04807994, 0.008821535, -0.043333855, 0.004359179, -0.027032072, -0.075112015, -0.026619367, -0.03507979, -0.0007996128, -0.0022311776, -0.0136192115, 0.039413173, -0.008718358, 0.04519102, 0.0213574, 0.03404803, -0.07057228, -0.008408831, -0.025484433, 0.036936954, -0.028270181, 0.006551666, -0.036524247, -0.0023343535, -0.032809917, -0.036936954, -0.042921152, -0.012432689, 0.021047872, 0.048286296, -0.007480249, 0.010472348, -0.019500235, -0.01588908, -0.033635326, -0.021151047, 0.024865378, 0.0144446185, 0.039413173, 0.020635169, 0.0038175061, 0.07015958, -0.024143148, -0.012535865, 0.017539894, 0.071397685, -0.031159105, -0.018778004, -0.0144446185, 0.033016272, -0.026825719, -0.031159105, 0.049524404, -0.017952597, 0.043746557, -0.02950829, 0.021666927, -0.06479443, 0.027444774, -0.004617119, 0.015063673, -0.0038175061, 0.00533935, 0.046841834, 0.023317741, -0.047460888, 0.028889237, 0.0427148, -0.0031210692, 0.010472348, -0.06727065, -0.060667396, -0.028889237, -0.04787359, 0.033635326, -0.053651437, -0.019293882, 0.061905507, 0.0038433003, 0.04642913, 0.010627112, -0.014960498, 0.0061905505, -0.014547794, -0.05488955, 0.027651126, 0.005545702, 0.020016113, 0.014031915, -0.03054005, -0.015166849, 0.00794454, 0.035698842, 0.008150891, -0.04147669, -0.009595353, -0.050762516, -0.037349656, -0.025174906, -0.010885051, -0.016095432, 0.009801705, 0.02084152, -0.0043333853, 0.03177816, 0.010265997, -0.0491117, -0.026206665, -0.04519102, 0.040857635, -0.044365615, 0.003327421, 0.01042076, -0.017333541, 0.0027857479, 0.026413016, 0.023420917, 0.019190706, 0.0028115418, 0.0035595666, -0.015166849, 0.03796871, -0.036524247, 0.021976454, -0.044571966, 0.020222465, -0.0014251163, 0.0183653, 0.02084152, -0.05530225, -0.013722387, -0.036111545, -0.018055772, -0.034873433, 0.010885051, -0.012690629, 0.0070159575, 0.016404958, -0.028682884, 5.9648533e-05, -0.02383362, -0.038587764, -0.014754145, -0.03920682, 0.013928739, -0.013722387, 0.047460888, 0.016198607, 0.021666927, 0.0610801, 0.02579396, 0.033841677, -0.029095588, -0.038381413, 0.021976454, -0.0049008527, -0.030746402, -0.018158948, -0.02579396, 0.015270025, -0.03446073, 0.013722387, 0.009543765, -0.008873123, -0.022182807, 0.014135091, -0.02806383, 0.025484433, 0.0015927771, 0.0035337727, -0.0034821848, 0.015992256, -0.03796871, -0.016301783, -0.022182807, -0.008873123, 0.011607283, -0.033841677, -0.0136192115, -0.019809762, -0.022905037, 0.023008212, 0.03404803, 0.011762046, -0.01939706, 0.0028373357, 0.036317896, -0.0069127814, -0.020119289, -0.010936639, -0.03425438, 0.008873123, -0.037556008, -0.037556008, 0.030127347, 0.03446073, 0.05901658, -0.0043849736, -0.01908753, 0.017230365, -0.009956469, 0.05488955, -0.019293882, 0.0610801, -0.0036885364, 0.0043333853, 0.025381258, 0.015992256, -0.00020151531, 0.091207445, 0.029920995, -0.004539737, -0.018571652, -0.026000313, 0.014238266, -0.047254536, 0.0243495, -0.019293882, 0.03776236, 0.017849421, 0.015785905, 0.035905194, 0.05488955, 0.042095743, 0.004178622, -0.021873279, 0.0012574556, 0.040032227, -0.011194579, 0.04498467, 0.04147669, 0.030746402, 0.010162821, 0.016611312, -0.03446073, -0.00045139433, -0.007273897, -0.022905037, -0.03446073, -0.0017152984, -0.034667082, -0.0006803157, -0.01908753, 0.034873433, 0.015270025, -0.03404803, -0.0075318366, 0.03528614, 0.059429288, 0.028270181, 0.037349656, -0.004488149, -0.013103332, 0.0038690942, 0.006758018, 0.032397214, 0.019190706, -0.0011542798, -0.027238423, 0.033841677, -0.020428818, 0.030952753, -0.0024504263, -0.011452518, 0.0035079787, 0.057365768, 0.0072223092, -0.042921152, 0.0051072044, -0.0021280018, -0.020428818, -0.03404803, 0.010214409, -0.028270181, 0.0015347407, 0.02084152, -0.022182807, -0.019293882, -0.008305656, -0.012226338, 0.0111429915, 0.017436717, 0.02207963, 0.007892952, 0.0734612, 0.053651437, 0.021460576, 0.0050040283, 0.0127938045, 0.01764307, 0.005390938, 0.0068611936, -0.006758018, -0.022905037, -0.053238735, -0.046222776, 0.018158948, 0.0144446185, -0.0054425257, 0.007428661, 0.0038690942, 0.05984199, -0.033016272, -0.034667082, 0.03177816, -0.005752053, 0.00969853, 0.015476377, -0.047048185, -0.033222623, 0.00034176998, -0.05984199, 0.09987421, -0.012277925, -0.040238578, 0.001986135, -0.037556008, -0.01465097, 0.024659026, 0.04890535, -0.027238423, 0.038587764, 0.0427148, -0.011710458, 0.005855229, -0.017539894, -0.027444774, 0.03054005, 0.026206665, 0.007119133, 0.037556008, 0.020635169, 0.009285826, 0.014857322, 0.032603566, -0.0062937266, 0.022492334, -0.041270338, -0.015682729, 0.021151047, -0.01908753, -0.03446073, 0.073048495, 0.060667396, -0.024143148, 0.002695469, -0.060667396, 0.013928739, -0.047254536, 0.011504106, -0.03920682, 0.02806383, -0.04168304, -0.04807994, 0.0049782344, -0.03157181, 0.18241489, 0.054476846, 0.043746557, 0.004849265, 0.07181039, 0.02403997, 0.023627268, 0.03425438, 0.024865378, -0.009750118, 0.08336608, -0.026000313, 0.020325642, -0.010988227, 0.014547794, 0.018778004, 0.0015992256, 0.03177816, -0.036936954, -0.0136192115, -0.05138157, -0.0008576492, -0.020428818, -0.043127503, -0.011297755, -0.0037401244, -0.015166849, -0.039413173, 0.02930194, -0.01588908, -0.0063195205, 0.01465097, 0.036317896, -0.012742217, 0.016095432, 0.0427148, 0.039619524, -0.03776236, -0.015166849, 0.045810074, -0.011555694, -0.07593742, 0.019293882, 0.005287762, -0.013000157, 0.036111545, -0.015270025, -0.021976454, -0.017436717, -0.048492648, 0.034873433, -0.06685795, -0.018674828, -0.042302094, -0.00073835213, -0.006035787, -0.035905194, -0.018571652, 0.017333541, 0.016611312, 0.021976454, 0.008408831, -0.0367306, -0.035698842, 0.037349656, 0.00794454, 0.04787359, 0.007170721, -0.005855229, -0.03879412, 0.0056488775, 0.007273897, -0.035698842, 0.030746402, 0.01712719, 0.062730916, -0.03177816, 0.04766724, -0.03177816, -0.036111545, -0.014238266, -4.534095e-05, 0.0073770727, -0.022389159, 0.06974687, -0.007273897, -0.03425438, 0.02259551, -0.05901658, 0.011091404, 0.012019985, 0.01888118, 0.052826032, -0.03177816, 0.0491117]]",
        "env_config": {
            "MAX_WARMUP_SEQUENCE_LENGTH": "512",
        },
        "args": [
            "--dtype", "bfloat16",
        ],
    },
}

@pytest.fixture(scope="module", params=TEST_CONFIGS.keys())
def test_config(request: SubRequest) -> Dict[str, Any]:
    """Fixture that provides model configurations for testing."""
    model_name = request.param
    test_config = TEST_CONFIGS[model_name]
    test_config["test_name"] = model_name
    return test_config


@pytest.fixture(scope="module")
def model_id(test_config: Dict[str, Any]) -> Generator[str, None, None]:
    yield test_config["model_id"]


@pytest.fixture(scope="module")
def test_name(test_config: Dict[str, Any]) -> Generator[str, None, None]:
    yield test_config["test_name"]


@pytest.fixture(scope="module")
def expected_outputs(test_config: Dict[str, Any]) -> Dict[str, str]:
    return {
        "expected_output": test_config["expected_output"],
    }


@pytest.fixture(scope="module")
def input(test_config: Dict[str, Any]) -> str:
    return test_config["input"]


@pytest.fixture(scope="function")
def tei_service(gaudi_launcher, model_id: str, test_name: str):
    with gaudi_launcher(model_id, test_name) as tei_service:
        yield tei_service


@pytest_asyncio.fixture(scope="function")
async def tei_client(tei_service):
    await tei_service.health(1000)
    return tei_service


@pytest.mark.asyncio
async def test_model_single_request(
    tei_client, expected_outputs: Dict[str, str], input: str
):
    print(f"type(tei_client) {tei_client}")
    response = await tei_client.generate(
        input,
    )
    
    response_array = np.array(response)
    expected_array = np.array(eval(expected_outputs["expected_output"]))

    assert np.allclose(response_array, expected_array, rtol=1e-5, atol=1e-5)